{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
  {% include "partials/_navbar.html" %}

  <!-- Dashboard Tabs -->
  <div class="container mt-4">
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="operations-tab" data-bs-toggle="tab" data-bs-target="#operations" type="button" role="tab">Operations</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">Products</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="mappings-tab" data-bs-toggle="tab" data-bs-target="#mappings" type="button" role="tab">Mappings</button>
      </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
      <!-- Operations Tab -->
      <div class="tab-pane fade show active" id="operations" role="tabpanel" aria-labelledby="operations-tab">
        {% include "partials/_operations.html" %}
      </div>

      <!-- Products Tab -->
      <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
        {% include "partials/_products.html" %}
      </div>

      <!-- Mappings Tab -->
      <div class="tab-pane fade" id="mappings" role="tabpanel" aria-labelledby="mappings-tab">
        {% include "partials/_mappings.html" %}
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    // Example: Poll logs every 10 seconds
    function fetchLogs() {
      fetch('/api/logs')
        .then(response => response.json())
        .then(data => {
          const logsContainer = document.getElementById('logsContainer');
          if (logsContainer) {
            logsContainer.innerHTML = '';
            data.logs.forEach(log => {
              const p = document.createElement('p');
              p.textContent = log;
              logsContainer.appendChild(p);
            });
          }
        })
        .catch(error => console.error('Error fetching logs:', error));
    }
    setInterval(fetchLogs, 10000);
    fetchLogs();


    document.getElementById('deleteLogsBtn').addEventListener('click', function() {
      const statusDiv = document.getElementById('operationStatus');
      fetch('/api/logs/clear', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'clear' })
      })
      .then(response => response.json())
      .then(data => {
        // show the status message for a few seconds
        statusDiv.textContent = data.message;
        setTimeout(() => {
          statusDiv.textContent = '';
        }, 3000);
        console.log('Logs cleared:', data);
        fetchLogs();
      })
    })

    // Operations functions
    document.getElementById('createBtn').addEventListener('click', function() {
      const statusDiv = document.getElementById('operationStatus');
      statusDiv.textContent = "Starting create process...";
      fetch('/api/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pause: 1, batch_size: 50 })
      })
      .then(response => response.json())
      .then(data => {
        statusDiv.textContent = data.message;
        setTimeout(() => {
          statusDiv.textContent = '';
        }, 3000);
        console.log('Create Process Result:', data);
        fetchLogs();
      })
      .catch(error => {
        statusDiv.textContent = "Error: " + error;
        console.error('Error in create process:', error);
      });
    });

    document.getElementById('updateBtn').addEventListener('click', function() {
      const statusDiv = document.getElementById('operationStatus');
      statusDiv.textContent = "Starting update process...";
      fetch('/api/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pause: 1, batch_size: 50 })
      })
      .then(response => response.json())
      .then(data => {
        statusDiv.textContent = data.message;
        setTimeout(() => {
          statusDiv.textContent = '';
        }, 3000);
        console.log('Update Process Result:', data);
        fetchLogs();
      })
      .catch(error => {
        statusDiv.textContent = "Error: " + error;
        console.error('Error in update process:', error);
      });
    });

    // Products functions
    function fetchProducts() {
      // Fetch Fitness1 products
      fetch('/api/products/fitness1')
        .then(response => response.json())
        .then(data => {
          const tbody = document.querySelector('#fitness1Table tbody');
          tbody.innerHTML = '';
          data.products.forEach(prod => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${prod.brand_name}</td>
                             <td>${prod.product_name}</td>
                             <td>${prod.category}</td>
                             <td>${prod.barcode}</td>
                             <td>${prod.regular_price}</td>`;
            tbody.appendChild(row);
          });
        })
        .catch(error => console.error('Error fetching Fitness1 products:', error));

      // Fetch EMAG products
      fetch('/api/products/emag')
        .then(response => response.json())
        .then(data => {
          const tbody = document.querySelector('#emagTable tbody');
          tbody.innerHTML = '';
          data.products.forEach(prod => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${prod.id}</td>
                             <td>${prod.name}</td>
                             <td>${prod.sale_price}</td>
                             <td>${prod.part_number}</td>
                             <td>${prod.status}</td>`;
            tbody.appendChild(row);
          });
        })
        .catch(error => console.error('Error fetching EMAG products:', error));
    }
</script>
<script>
    // Global variable to store allowed categories
let allowedCategories = [];

// Function to load allowed categories from the API
function loadAllowedCategories() {
  fetch('/api/categories')
    .then(response => response.json())
    .then(data => {
      allowedCategories = data.categories.map(cat => cat.name);
      // Populate dropdowns in new mapping form
      const newEmagSelect = document.getElementById('newEmagCat');
      newEmagSelect.innerHTML = '';
      allowedCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        newEmagSelect.appendChild(option);
      });
    })
    .catch(error => console.error('Error fetching categories:', error));
}

// Call this when the dashboard loads
loadAllowedCategories();

// Refresh mappings: populate the mappings table with a dropdown for EMAG category.
function refreshMappings() {
  fetch('/api/mappings')
    .then(response => response.json())
    .then(data => {
      const tbody = document.querySelector('#mappingsTable tbody');
      tbody.innerHTML = '';
      const mappings = data.mappings;
      for (const id in mappings) {
        const mapping = mappings[id];
        const row = document.createElement('tr');
        row.dataset.id = id;
        // Fitness1 category is shown as text
        const cell1 = `<td>${mapping.fitness1_category}</td>`;
        // EMAG category: dropdown populated with allowed categories, with the current value selected
        let selectHTML = `<select class="form-control emag-select">`;
        allowedCategories.forEach(cat => {
          selectHTML += `<option value="${cat}" ${cat === mapping.emag_category ? 'selected' : ''}>${cat}</option>`;
        });
        selectHTML += `</select>`;
        const cell2 = `<td>${selectHTML}</td>`;
        row.innerHTML = cell1 + cell2;
        tbody.appendChild(row);
      }
    })
    .catch(error => console.error('Error fetching mappings:', error));
}

// Save all mappings: iterate over table rows and send bulk update.
function saveAllMappings() {
  const updates = [];
  document.querySelectorAll('#mappingsTable tbody tr').forEach(row => {
    const id = row.dataset.id;
    const newEmagCat = row.querySelector('.emag-select').value;
    updates.push({ id: id, emag_category: newEmagCat });
  });
  fetch('/api/mappings', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ updates: updates })
  })
  .then(response => response.json())
  .then(data => {
    alert(data.status === "success" ? "Mappings updated!" : "Error: " + data.message);
    refreshMappings();
  })
  .catch(error => console.error('Error updating mappings:', error));
}

// New mapping functions (unchanged except for dropdown population)
function showNewMappingForm() {
  document.getElementById('newMappingForm').style.display = 'block';
}
function hideNewMappingForm() {
  document.getElementById('newMappingForm').style.display = 'none';
}
function createMapping() {
  const fitness1Cat = document.getElementById('newFitness1Cat').value;
  const emagCat = document.getElementById('newEmagCat').value;
  fetch('/api/mappings', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ fitness1_category: fitness1Cat, emag_category: emagCat })
  })
  .then(response => response.json())
  .then(data => {
    alert(data.status === "success" ? "Mapping created!" : "Error: " + data.message);
    hideNewMappingForm();
    refreshMappings();
  })
  .catch(error => console.error('Error creating mapping:', error));
}
 // Refresh mappings when the Mappings tab is clicked
  document.getElementById('mappings-tab').addEventListener('click', refreshMappings);


</script>
{% endblock %}
